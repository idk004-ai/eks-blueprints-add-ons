apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: otelcol-gateway
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - list:
        elements:
          - appName: otelcol-gateway
            releaseName: otelcol-gateway
            namespace: observability
            server: https://kubernetes.default.svc
  template:
    metadata:
      name: "{{.appName}}"
      labels:
        app.kubernetes.io/name: otelcol-gateway
        app.kubernetes.io/part-of: observability
    spec:
      project: default
      destination:
        server: "{{.server}}"
        namespace: "{{.namespace}}"

      ignoreDifferences:
        - group: apps
          kind: StatefulSet
          jqPathExpressions:
            - .spec.volumeClaimTemplates[]?.apiVersion
            - .spec.volumeClaimTemplates[]?.kind

      source:
        repoURL: https://open-telemetry.github.io/opentelemetry-helm-charts
        chart: opentelemetry-collector
        # Bạn có thể pin chart version theo nhu cầu (ví dụ 0.143.0 là một bản gần đây)
        targetRevision: 0.143.0
        helm:
          releaseName: "{{.releaseName}}"
          values: |-
            mode: statefulset

            replicaCount: 1

            image:
              repository: "otel/opentelemetry-collector-contrib"

            command:
              name: otelcol-contrib

            podSecurityContext:
              runAsNonRoot: true
              runAsUser: 10001
              runAsGroup: 10001
              fsGroup: 10001
              fsGroupChangePolicy: "OnRootMismatch"
    
            # Mount cho WAL/queue (file_storage)
            extraVolumeMounts:
              - name: queue
                mountPath: /var/lib/otelcol

            statefulset:
              # volumeClaimTemplates for a statefulset
              volumeClaimTemplates:
                - metadata:
                    name: queue
                  spec:
                    accessModes: ["ReadWriteOnce"]
                    resources:
                      requests:
                        storage: 10Gi
                    # storageClassName: gp3  # (EKS) nếu bạn muốn pin SC, còn không thì bỏ để dùng default

            ports:
              zipkin:
                enabled: false
                containerPort: 9411
                servicePort: 9411
                protocol: TCP
              metrics:
                enabled: true
                containerPort: 8888
                servicePort: 8888
                protocol: TCP
              otlp:
                enabled: true
                containerPort: 4317
                servicePort: 4317
                protocol: TCP
              otlp-http:
                enabled: true
                containerPort: 4318
                servicePort: 4318
                protocol: TCP

            config:
              extensions:
                file_storage:
                  directory: /var/lib/otelcol
                health_check:
                  endpoint: "0.0.0.0:13133"
              receivers:
                otlp:
                  protocols:
                    grpc: 
                      endpoint: 0.0.0.0:4317
                    http: 
                      endpoint: 0.0.0.0:4318
              processors:
                batch: {}
              exporters:
                zipkin:
                  endpoint: "http://zipkin.observability.svc.cluster.local:9411/api/v2/spans"
                  sending_queue:
                    enabled: true
                    queue_size: 10000
                    storage: file_storage
                  retry_on_failure:
                    enabled: true
                    initial_interval: 5s
                    max_interval: 30s
                    max_elapsed_time: 10m
                debug:
                  verbosity: detailed
              service:
                telemetry:
                  metrics:
                    address: 0.0.0.0:8888
                extensions: [health_check, file_storage]
                pipelines:
                  traces:
                    receivers: [otlp]
                    processors: [batch]
                    exporters: [zipkin, debug]
                  metrics:
                    receivers: [otlp]
                    processors: [batch]
                    exporters: [debug]
                  logs:
                    receivers: [otlp]
                    processors: [batch]
                    exporters: [debug]

            resources:
              limits:
                cpu: 100m
                memory: 200Mi

            autoscaling:
              enabled: true
              minReplicas: 1
              maxReplicas: 10
              targetCPUUtilizationPercentage: 80

            service:
              enabled: true
              type: ClusterIP

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
          - RespectIgnoreDifferences=true
